name: Watch Patches Releases
on:
  schedule:
    # Vérifie toutes les heures si de nouvelles releases sont disponibles
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check ReVanced patches releases
        id: check_revanced
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const { data: releases } = await github.rest.repos.listReleases({
              owner: 'ReVanced',
              repo: 'revanced-patches',
              per_page: 1
            });

            if (releases.length > 0) {
              const latestRelease = releases[0];
              const releaseTag = latestRelease.tag_name;
              
              // Lire la dernière release vérifiée depuis un fichier
              const lastCheckedFile = path.join(process.cwd(), '.last-revanced-tag');
              let lastCheckedTag = '';
              try {
                if (fs.existsSync(lastCheckedFile)) {
                  lastCheckedTag = fs.readFileSync(lastCheckedFile, 'utf8').trim();
                }
              } catch (e) {
                console.log('Fichier de dernière release non trouvé, première exécution');
              }
              
              if (releaseTag !== lastCheckedTag) {
                console.log(`Nouvelle release ReVanced détectée: ${releaseTag} (ancienne: ${lastCheckedTag || 'aucune'})`);
                
                // Sauvegarder la nouvelle release
                fs.writeFileSync(lastCheckedFile, releaseTag);
                
                // Déclencher directement le workflow de build
                const { data: repo } = await github.rest.repos.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'build.yml',
                  ref: repo.default_branch || 'main'
                });
              } else {
                console.log(`Pas de nouvelle release ReVanced. Dernière: ${releaseTag}`);
              }
            }

      - name: Check anddea patches releases
        id: check_anddea
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const { data: releases } = await github.rest.repos.listReleases({
              owner: 'anddea',
              repo: 'revanced-patches',
              per_page: 1
            });

            if (releases.length > 0) {
              const latestRelease = releases[0];
              const releaseTag = latestRelease.tag_name;
              
              // Lire la dernière release vérifiée depuis un fichier
              const lastCheckedFile = path.join(process.cwd(), '.last-anddea-tag');
              let lastCheckedTag = '';
              try {
                if (fs.existsSync(lastCheckedFile)) {
                  lastCheckedTag = fs.readFileSync(lastCheckedFile, 'utf8').trim();
                }
              } catch (e) {
                console.log('Fichier de dernière release non trouvé, première exécution');
              }
              
              if (releaseTag !== lastCheckedTag) {
                console.log(`Nouvelle release anddea détectée: ${releaseTag} (ancienne: ${lastCheckedTag || 'aucune'})`);
                
                // Sauvegarder la nouvelle release
                fs.writeFileSync(lastCheckedFile, releaseTag);
                
                // Déclencher directement le workflow de build
                const { data: repo } = await github.rest.repos.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'build.yml',
                  ref: repo.default_branch || 'main'
                });
              } else {
                console.log(`Pas de nouvelle release anddea. Dernière: ${releaseTag}`);
              }
            }

      - name: Commit last checked tags
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: .last-*-tag
          commit_message: Update last checked release tags
          skip_dirty_check: true
